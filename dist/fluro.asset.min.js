angular.module("fluro.asset",[]),angular.module("fluro.asset").service("Asset",["Fluro","$window","$http",function(Fluro,$window,$http){var controller={};controller.getUrl=function(id,params){if(id){var extension;params&&_.isString(params)&&(extension=params),params||(params={});var url=Fluro.apiURL+"/get/"+id;extension&&(params.extension=extension),params.extension&&params.extension.length&&(url+=params.filename&&params.filename.length?"/file/"+params.filename+"."+params.extension:"/file/file."+params.extension,delete params.extension),params.withoutToken||!params.access_token&&Fluro.token&&(params.access_token=Fluro.token);var queryParams=_.map(params,function(v,k){return encodeURIComponent(k)+"="+encodeURIComponent(v)}).join("&");return queryParams.length&&(url+="?"+queryParams),url}},controller.thumbnailUrl=function(id){return controller.getUrl(id,{w:50})};var isRetina=window.devicePixelRatio>1;return console.log("is retina"),controller.imageUrl=function(_id,w,h,params){if(_id){params||(params={});var limitWidth,url=Fluro.apiURL+"/get/"+_id;limitWidth=isRetina?1920:1200,$window.screen.width<=768&&(limitWidth=isRetina?1536:768),$window.screen.width<=320&&(limitWidth=isRetina?640:320),w||h?(w&&(params.w=w),h&&(params.h=h)):params.w=limitWidth,params.extension&&params.extension.length&&(url+=params.filename&&params.filename.length?"/file/"+params.filename+"."+params.extension:"/file/file."+params.extension,delete params.extension),params.withoutToken||!params.access_token&&Fluro.token&&(params.access_token=Fluro.token),params.quality||(params.quality=90);var queryParams=_.map(params,function(v,k){return encodeURIComponent(k)+"="+encodeURIComponent(v)}).join("&");if(queryParams.length&&(url+="?"+queryParams),!params.base64)return url;var requestConfig={method:"get",url:url,responseType:"arraybuffer",cache:"true"};$http(requestConfig).then(function(data){var i,j,subArray,arr=new Uint8Array(data),raw="",chunk=5e3;for(i=0,j=arr.length;i<j;i+=chunk)subArray=arr.subarray(i,i+chunk),raw+=String.fromCharCode.apply(null,subArray);var b64=btoa(raw);return console.log("return blob"),"data:image/jpeg;base64,"+b64})}},controller.downloadUrl=function(id,params){if(id){params||(params={});var url=Fluro.apiURL+"/download/"+id;params.extension&&params.extension.length&&(url+=params.filename&&params.filename.length?"/file/"+params.filename+"."+params.extension:"/file/file."+params.extension,delete params.extension),params.withoutToken||!params.access_token&&Fluro.token&&(params.access_token=Fluro.token);var queryParams=_.map(params,function(v,k){return encodeURIComponent(k)+"="+encodeURIComponent(v)}).join("&");return queryParams.length&&(url+="?"+queryParams),url}},controller.avatarUrl=function(id,style,params){params||(params={}),style||(style="user");var url=Fluro.apiURL+"/get/avatar/"+style+"/"+id;Fluro.token&&(params.access_token=Fluro.token);var queryParams=_.map(params,function(v,k){return encodeURIComponent(k)+"="+encodeURIComponent(v)}).join("&");return queryParams.length&&(url+="?"+queryParams),url},controller.isAssetType=function(object){switch(object._type){case"asset":case"video":case"audio":case"image":return!0;default:return!1}},controller}]);